import ee
import datetime
import pandas as pd

# Initialize the Earth Engine API
ee.Initialize()

# Define the date range
start_date = '2022-01-01'
end_date = '2022-01-10'  # Adjust as needed

# Define region: Southern CÃ´te d'Ivoire (bounding box)
# You can adjust this to a more specific geometry if needed
roi = ee.Geometry.Rectangle([-8.5, 4.5, -2.5, 6.5])  # Roughly southern CI

# Load the ERA5-Land hourly 2m temperature data
dataset = ee.ImageCollection("ECMWF/ERA5_LAND/HOURLY") \
             .filterDate(start_date, end_date) \
             .select("temperature_2m")

# Convert Kelvin to Celsius
def k_to_c(image):
    return image.subtract(273.15).copyProperties(image, image.propertyNames())

dataset_celsius = dataset.map(k_to_c)

# Generate a list of dates
start = datetime.datetime.strptime(start_date, "%Y-%m-%d")
end = datetime.datetime.strptime(end_date, "%Y-%m-%d")
n_days = (end - start).days

dates = [start + datetime.timedelta(days=i) for i in range(n_days)]

# Aggregate daily max and min temperatures
def get_daily_temp(date):
    date = ee.Date(date)
    daily = dataset_celsius.filterDate(date, date.advance(1, 'day'))
    daily_max = daily.max().reduceRegion(
        reducer=ee.Reducer.mean(),
        geometry=roi,
        scale=1000,
        maxPixels=1e9
    )
    daily_min = daily.min().reduceRegion(
        reducer=ee.Reducer.mean(),
        geometry=roi,
        scale=1000,
        maxPixels=1e9
    )
    return {
        'date': date.format('YYYY-MM-dd').getInfo(),
        'Tmax_C': daily_max.get('temperature_2m').getInfo(),
        'Tmin_C': daily_min.get('temperature_2m').getInfo()
    }

# Run over each day and collect results
results = []
for d in dates:
    try:
        result = get_daily_temp(d.isoformat())
        results.append(result)
    except Exception as e:
        print(f"Failed for {d.date()}: {e}")

# Convert to DataFrame and save
df = pd.DataFrame(results)
df.to_csv('era5_daily_temp_southern_ivory_coast.csv', index=False)

print("Download complete: era5_daily_temp_southern_ivory_coast.csv")
